<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog Detail</title>
    <!-- Correcting the Bootstrap and Font Awesome links -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>

  <body>
    <!-- Blog Details Container -->
    <div id="blog-detail" class="container py-5">
      <div id="blog-content">
        <!-- The blog content will be rendered here -->
      </div>
    </div>

    <script>
      // Function to fetch single blog based on slug
      function fetchBlogDetail(slug) {
        fetch(
          `https://life-insurance-website-template-uthayas-projects-5d5b23e4.vercel.app/api/blogs/${slug}`
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error("Blog not found");
            }
            return response.json();
          })
          .then((result) => {
            console.log("Fetched single blog data:", result);

            if (!result || !result.items || result.items.length === 0) {
              console.error("No blog found with the provided slug.");
              return;
            }

            const blogItem = transformBlogData(
              result.items[0],
              result.includes
            );
            renderBlogDetail(blogItem);
          })
          .catch((err) => console.error("Error fetching blog details:", err));
      }

      // Extract slug from query string
      function getBlogSlugFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const slug = params.get("slug");
        console.log(slug, "slug from query string");
        return slug;
      }

      // Transform raw Contentful blog data into usable format
      function transformBlogData(item, includes) {
        const fields = item.fields;
        return {
          blogTitle: fields.blogTitle || "Untitled",
          blogDescription: fields.blogDescription || {},
          blogAuthor: fields.blogAuthor || "Admin",
          blogDate: fields.blogDate,
          blogThumbnailImage: fields.blogThumbnailImage
            ? getImageUrl(fields.blogThumbnailImage, includes)
            : null,
        };
      }

      // Get image URL from includes
      function getImageUrl(imageField, includes) {
        if (!includes || !includes.Asset) return null;

        const asset = includes.Asset.find(
          (a) => a.sys.id === imageField.sys.id
        );
        return asset ? `https:${asset.fields.file.url}` : null;
      }

      // Render single blog details
      function renderBlogDetail(blogItem) {
        const blogDetailContainer = document.getElementById("blog-content");

        const blogTitle = blogItem.blogTitle;
        const blogDescription = convertRichTextToHtml(blogItem.blogDescription);
        const blogAuthor = blogItem.blogAuthor;
        const blogDate = formatDate(blogItem.blogDate);
        const blogThumbnailImage = blogItem.blogThumbnailImage;

        blogDetailContainer.innerHTML = `
          <h1 class="display-4 mb-4">${blogTitle}</h1>
          <div class="small text-muted mb-4">
            <span class="fa fa-user text-primary"></span> ${blogAuthor} | 
            <span class="fa fa-calendar text-primary"></span> ${blogDate}
          </div>
          ${
            blogThumbnailImage
              ? `<img src="${blogThumbnailImage}" class="img-fluid rounded mb-4" alt="${blogTitle}" />`
              : ""
          }
          <div class="blog-description">${blogDescription}</div>
        `;
      }

      // Convert rich text to HTML
      function convertRichTextToHtml(richText) {
        if (!richText || !richText.content) return "";

        let htmlContent = "";

        richText.content.forEach((node) => {
          if (node.nodeType === "paragraph") {
            let paragraph = "";
            node.content.forEach((textNode) => {
              if (textNode.nodeType === "text") {
                const text = textNode.value;
                const hasBold = textNode.marks.some((m) => m.type === "bold");
                const hasItalic = textNode.marks.some(
                  (m) => m.type === "italic"
                );

                let finalText = text;
                if (hasBold) finalText = `<strong>${finalText}</strong>`;
                if (hasItalic) finalText = `<em>${finalText}</em>`;

                paragraph += finalText;
              }
            });
            htmlContent += `<p>${paragraph}</p>`;
          }
        });

        return htmlContent;
      }

      // Format date
      function formatDate(dateString) {
        if (!dateString) return "";
        const options = { day: "numeric", month: "short", year: "numeric" };
        return new Date(dateString).toLocaleDateString("en-US", options);
      }

      // Run on page load
      document.addEventListener("DOMContentLoaded", function () {
        const slug = getBlogSlugFromUrl();
        if (slug) {
          fetchBlogDetail(slug);
        } else {
          console.error("No slug found in URL.");
        }
      });
    </script>
  </body>
</html>
